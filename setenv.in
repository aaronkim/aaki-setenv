#!/bin/bash
export DEBUG="yes"

PREFIX=aaki
PWD=$(/bin/pwd)

if [ "$DEBUG" == "yes" ]
  then
    echo DEBUG = yes
    export ECHO='echo'
  else
    echo DEBUG = no
    export ECHO='test'
fi

$ECHO "PWD = $PWD"
$ECHO "ENV_TOP = $ENV_TOP"

function get_top() {
    unset ENV_TOP
    local TOPFILE=".$PREFIX/setenv/setenv.in"

    if [ -d "$ENV_TOP" -a -f "$ENV_TOP/$TOPFILE" ]
      then
        (cd $ENV_TOP; PWD=$(/bin/pwd))
        $ECHO "get_top = 1"
      else
        if [ -f $TOPFILE ]
          then
            ENV_TOP=$PWD
            $ECHO "get_top = 2"
          else
            $ECHO "get_top = 3"
            local HERE=$PWD
            T=
            while [ \( ! \( -f $TOPFILE \) \) -a \( $PWD != "/" \) ]; do
              cd ..
              T=$PWD
              $ECHO "T = $T"
              if [ -f "$T/$TOPFILE" ]
                then
                  $ECHO "get_top = 4"
                  ENV_TOP=$T
                  break
              fi
            done
            cd $HERE
        fi
    fi

    export ENV_TOP=$ENV_TOP
    echo "ENV_TOP=$ENV_TOP"
    
  unset get_top
}

function set_aaki_repo() {
  local REPO_PREFIX=.$PREFIX
  local REPO_URL=git@github.com:aaronkim/aaki-manifest.git
  local REPO_BASE_BRANCH=master
  local REPO_WORK_BRANCH=develop

  if [ -d "$ENV_TOP" ]
    then
      export ENV_TOP=$ENV_TOP
    else
      export ENV_TOP=$PWD
  fi

  cd $ENV_TOP
  if [ -d $REPO_PREFIX/.repo ]
    then
      $ECHO "set_aaki_repo 1"
      cd $REPO_PREFIX
      repo sync
    else
      $ECHO "set_aaki_repo 2"
      mkdir $REPO_PREFIX -p
      cd $REPO_PREFIX
      repo init -u $REPO_URL -b $REPO_WORK_BRANCH
      repo sync
      repo start $REPO_WORK_BRANCH --all
      # repo forall -c 'git branch --set-upstream-to=$REPO_REMOTE/'"$REPO_BASE_BRANCH $REPO_WORK_BRANCH"
      # repo sync
  fi
  cd $ENV_TOP

  unset set_aaki_repo
}

function set_bcdm_repo() {
  local REPO_PREFIX=bcdm
  local REPO_URL=git@github.com:aaronkim/aaki-bcdm-manifest.git
  local REPO_BASE_BRANCH=master
  local REPO_WORK_BRANCH=develop

  if [ -d "$ENV_TOP" ]
    then
      export ENV_TOP=$ENV_TOP
    else
      export ENV_TOP=$PWD
  fi

  cd $ENV_TOP
  if [ -d $REPO_PREFIX/.repo ]
    then
      $ECHO "set_bcdm_repo 1"
      cd $REPO_PREFIX
      ln -s manifests/local_manifests .repo/local_manifests
      repo sync
    else
      $ECHO "set_bcdm_repo 2"
      mkdir $REPO_PREFIX -p
      cd $REPO_PREFIX
      repo init -u $REPO_URL -b $REPO_WORK_BRANCH
      ln -s manifests/local_manifests .repo/local_manifests
      repo sync
      repo start $REPO_WORK_BRANCH --all
      # repo forall -c 'git branch --set-upstream-to=$REPO_REMOTE/'"$REPO_BASE_BRANCH $REPO_WORK_BRANCH"
      # repo sync
  fi
  cd $ENV_TOP

  unset set_bcdm_repo
}

function set_aaki() {
  if [ -f $PREFIX ]
    then
      alias $PREFIX='. $ENV_TOP/$PREFIX'
    else
      $ECHO "not found aaki"
  fi
}

COMMAND_ITEMS="top"
if [ -d $ENV_TOP/.$PREFIX/setenv/*/ ]
  then
    COMMAND_ITEMS=$COMMAND_ITEMS $(ls -d $ENV_TOP/.$PREFIX/setenv/*/ | sed "s|$ENV_TOP/.$PREFIX/setenv/||g;s|/||g;s|setenv||g")
  else
    COMMAND_ITEMS=$COMMAND_ITEMS
fi

function _comp() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"
    opts="--help --verbose --version"

#    $ECHO "opts = $opts"
#    $ECHO "opts{} = ${opts}"
#    $ECHO "\$#=$#"
#    $ECHO "\$0=$0"
#    $ECHO "\$1=$1"
#    $ECHO "\$2=$2"
#    $ECHO "\$3=$3"
#    $ECHO "\$4=$4"
#    $ECHO "\$5=$5"

    if [[ ${cur} == -* ]]
      then
        COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
        return 0
      else
        COMPREPLY=( $(compgen -W "${COMMAND_ITEMS}" -- ${cur}) )
        return 0
    fi
}
#complete -o nospace -F _comp aaki
complete -F _comp aaki


$ECHO "opts=$opts"
$ECHO "opts{}=${opts}"
$ECHO "COMMAND_ITEMS=$COMMAND_ITEMS"
$ECHO "COMMAND_ITEMS{}=${COMMAND_ITEMS}"

get_top
$ECHO "get_top = $ENV_TOP"
set_aaki_repo
set_bcdm_repo
set_aaki
