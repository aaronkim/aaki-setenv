#!/bin/bash
export DEBUG="yes"

PREFIX=aaki
PWD=$(/bin/pwd)

if [ "$DEBUG" == "yes" ]
  then
    echo DEBUG = yes
    ECHO='echo'
  else
    echo DEBUG = no
    ECHO='test'
fi

$ECHO "PWD = $PWD"
$ECHO "ENV_TOP = $ENV_TOP"

function get_top() {
    unset ENV_TOP
    local TOPFILE=".$PREFIX/setenv/setenv.in"

    if [ -d "$ENV_TOP" -a -f "$ENV_TOP/$TOPFILE" ]
      then
        (cd $ENV_TOP; PWD=$(/bin/pwd))
        $ECHO "get_top = 1"
      else
        if [ -f $TOPFILE ]
          then
            ENV_TOP=$PWD
            $ECHO "get_top = 2"
          else
            $ECHO "get_top = 3"
            local HERE=$PWD
            T=
            while [ \( ! \( -f $TOPFILE \) \) -a \( $PWD != "/" \) ]; do
              cd ..
              T=$PWD
              $ECHO "T = $T"
              if [ -f "$T/$TOPFILE" ]
                then
                  $ECHO "get_top = 4"
                  ENV_TOP=$T
                  break
              fi
            done
            cd $HERE
        fi
    fi

    export ENV_TOP=$ENV_TOP
    echo "ENV_TOP=$ENV_TOP"
    
  unset get_top
}

function set_repo() {
  local REPO_URL=git@github.com:aaronkim/$PREFIX-manifest.git
  local REPO_BASE_BRANCH=master
  local REPO_WORK_BRANCH=develop

  if [ -d "$ENV_TOP" ]
    then
      ENV_TOP=$ENV_TOP
    else
      ENV_TOP=$PWD
  fi

  cd $ENV_TOP
  if [ -d .$PREFIX/.repo ]
    then
      $ECHO "set_repo 1"
      cd .$PREFIX
      repo sync
    else
      $ECHO "set_repo 2"
      mkdir .$PREFIX -p
      cd .$PREFIX
      repo init -u $REPO_URL -b $REPO_WORK_BRANCH
      repo sync
      repo start $REPO_WORK_BRANCH --all
      repo forall -c 'git branch --set-upstream-to=$REPO_REMOTE/$REPO_BASE_BRANCH $REPO_WORK_BRANCH'
      repo sync
  fi
  cd $ENV_TOP

  unset set_repo
}

function set_aaki() {
  if [ -f $PREFIX ]
    then
      alias $PREFIX=./$PREFIX
    else
      $ECHO "not found aaki"
  fi
}

COMMAND_ITEMS=$(ls -d $ENV_TOP/.aaki/*/ | sed "s|$ENV_TOP/.aaki||g;s|/||g")

function _comp() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"
    opts="--help --verbose --version"

#    $ECHO "opts = $opts"
#    $ECHO "opts{} = ${opts}"
    if [[ ${cur} == -* ]]
      then
        COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
        return 0
      else
        COMPREPLY=( $(compgen -W "${COMMAND_ITEMS}" -- ${cur}) )
        return 0
    fi
}
complete -o nospace -F _comp aaki
#complete -F _comp aaki


$ECHO "opts=$opts"
$ECHO "opts{}=${opts}"
$ECHO "COMMAND_ITEMS=$COMMAND_ITEMS"
$ECHO "COMMAND_ITEMS{}=${COMMAND_ITEMS}"

get_top
$ECHO "get_top = $ENV_TOP"
set_repo
$ECHO "get_top = $ENV_TOP"
set_aaki
